<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crime Analysis & Prediction Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .container { margin-top: 30px; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,.05); }
        .chart-container { height: 350px; padding: 10px; } 
        canvas { max-width: 100%; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center text-primary">ðŸ‡®ðŸ‡³ Crime Analysis & Prediction Dashboard</h1>
        
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item"><a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab">Dashboard</a></li>
            <li class="nav-item"><a class="nav-link" id="city-analysis-tab" data-bs-toggle="tab" href="#city-analysis" role="tab">City & Year Analysis</a></li>
            <li class="nav-item"><a class="nav-link" id="prediction-tab" data-bs-toggle="tab" href="#prediction" role="tab">Prediction</a></li>
        </ul>
        
        <div class="tab-content" id="myTabContent">
            
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                <div class="card mt-4"><div class="card-body">
                    <h5 class="card-title">Overall Trends & Model Performance</h5>
                    <div class="row">
                        <div class="col-md-6 chart-container"><canvas id="genderChart"></canvas></div>
                        <div class="col-md-6 chart-container"><canvas id="hourlyChart"></canvas></div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-md-6 chart-container"><canvas id="stateChart"></canvas></div>
                        <div class="col-md-6 chart-container"><canvas id="crimeTypeChart"></canvas></div>
                    </div>
                    <div class="row mt-4">
                        <h6 class="text-center">Machine Learning Model Comparison</h6>
                        <div class="col-md-12 chart-container"><canvas id="metricsChart"></canvas></div>
                    </div>
                </div></div>
            </div>

            <div class="tab-pane fade" id="city-analysis" role="tabpanel">
                <div class="card mt-4"><div class="card-body">
                    <h5 class="card-title">Analyze Crime by City and Year</h5>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="citySelect" class="form-label">City Name</label>
                            <select id="citySelect" class="form-select"></select>
                        </div>
                        <div class="col-md-3">
                            <label for="yearInput" class="form-label">Year</label>
                            <select id="yearInput" class="form-select"></select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button id="analyzeCityBtn" class="btn btn-primary w-100">Generate Analysis</button>
                        </div>
                    </div>
                    <p class="mt-3 fs-5" id="citySummary">Select a city and year to see the analysis...</p>
                    <div class="row mt-4">
                        <div class="col-md-6 chart-container"><canvas id="yearlyCityChart"></canvas></div>
                        <div class="col-md-6 chart-container"><canvas id="top5CityCrimesChart"></canvas></div>
                    </div>
                </div></div>
            </div>
            
            <div class="tab-pane fade" id="prediction" role="tabpanel">
                <div class="card mt-4"><div class="card-body">
                    <h5 class="card-title">Predict Case Status (Case Closed: Yes/No)</h5>
                    <div id="predictionForm">
                        <div class="row mb-3">
                            <div class="col-md-4"><label for="predCity">City</label><select id="predCity" class="form-select"></select></div>
                            <div class="col-md-4"><label for="predType">Primary Crime Type</label><select id="predType" class="form-select"></select></div>
                            <div class="col-md-4"><label for="predGender">Victim Gender</label><select id="predGender" class="form-select"></select></div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><label for="predAge">Victim Age</label><input type="number" id="predAge" class="form-control" value="30" min="10" max="99"></div>
                            <div class="col-md-3"><label for="predWeapon">Weapon Used</label><select id="predWeapon" class="form-select"></select></div>
                            <div class="col-md-3"><label for="predPolice">Police Deployed</label><input type="number" id="predPolice" class="form-control" value="5" min="0"></div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><label for="predDate">Date (YYYY-MM-DD)</label><input type="text" id="predDate" class="form-control" value="2025-10-05"></div>
                            <div class="col-md-3"><label for="predTime">Time (HH:MM:SS)</label><input type="text" id="predTime" class="form-control" value="14:30:00"></div>
                        </div>
                        <button id="predictBtn" class="btn btn-success mt-3">Get Prediction</button>
                    </div>
                    <div class="alert mt-4" id="predictionResult" style="display: none;"></div>
                </div></div>
            </div>

        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        window.ChartInstances = {};

        // --- DATA FETCHING AND CHART RENDERING ---

        async function fetchAnalysisData() {
            try {
                const response = await fetch('/api/analysis');
                if (!response.ok) throw new Error('Failed to fetch analysis data');
                const data = await response.json();
                
                // CRITICAL STEP: Call populateDropdowns ONLY after data is successfully fetched
                populateDropdowns(data.dropdown_data); 
                renderDashboardCharts(data.dashboard_data);
                
            } catch (error) {
                console.error("Error loading dashboard data:", error);
                document.getElementById('citySummary').innerHTML = `<span class="text-danger">Error loading data from server: ${error.message}. Check if 'crime_dataset_india.csv' is present and the Flask server is running.</span>`;
            }
        }

        function populateDropdowns(data) {
            
            // Helper function to fill a select element
            const fillSelect = (id, items, includeDefault = true) => {
                const select = document.getElementById(id);
                select.innerHTML = ''; // Clear existing options
                
                if (includeDefault) {
                    // Add a disabled placeholder option for analysis tabs
                    const defaultOption = document.createElement('option');
                    defaultOption.text = "Select...";
                    defaultOption.value = "";
                    defaultOption.disabled = true;
                    defaultOption.selected = true;
                    select.add(defaultOption);
                }

                items.forEach(item => select.add(new Option(item, item)));
                
                // If no placeholder is included (prediction tab), select the first item as the default selection
                if (!includeDefault && items.length > 0) {
                    select.value = items[0];
                }
            };

            // City Analysis Tab Dropdowns 
            fillSelect('citySelect', data.cities);
            fillSelect('yearInput', data.years); 

            // Prediction Tab Dropdowns (Set first item as default value)
            fillSelect('predCity', data.cities, false); 
            fillSelect('predType', data.primary_types, false);
            fillSelect('predGender', data.genders, false);
            fillSelect('predWeapon', data.weapons, false);
        }

        function renderDashboardCharts(data) {
            
            // Destroy old charts to prevent memory leaks in reloads
            Object.values(window.ChartInstances).forEach(chart => chart && chart.destroy());
            window.ChartInstances = {};

            const createChart = (ctx, type, title, labels, values, colors) => {
                const chart = new Chart(ctx, {
                    type: type,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: title,
                            data: values,
                            backgroundColor: colors,
                            borderColor: colors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { title: { display: true, text: title } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
                window.ChartInstances[ctx.id] = chart;
                return chart;
            };

            // Gender Distribution (Pie Chart)
            createChart(document.getElementById('genderChart').getContext('2d'), 'pie', 'Victim Gender Distribution', 
                Object.keys(data.gender_dist), Object.values(data.gender_dist), 
                ['#4e73df', '#1cc88a', '#36b9cc']);

            // Crimes by Hour of Day (Line Chart)
            createChart(document.getElementById('hourlyChart').getContext('2d'), 'line', 'Crimes by Hour of Day', 
                Object.keys(data.hourly_trend), Object.values(data.hourly_trend), 'rgba(255, 99, 132, 0.8)');

            // Top 10 States (Bar Chart)
            createChart(document.getElementById('stateChart').getContext('2d'), 'bar', 'Top 10 Crime States', 
                Object.keys(data.top_10_states), Object.values(data.top_10_states), '#f6c23e');

            // Top 10 Crime Types (Bar Chart)
            createChart(document.getElementById('crimeTypeChart').getContext('2d'), 'bar', 'Top 10 Crime Types', 
                Object.keys(data.top_10_crimes), Object.values(data.top_10_crimes), '#800080');

            // Model Performance (Metrics Chart)
            const metricsCtx = document.getElementById('metricsChart').getContext('2d');
            window.ChartInstances.metricsChart = new Chart(metricsCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(data.model_metrics.Accuracy),
                    datasets: [
                        { label: 'Accuracy', data: Object.values(data.model_metrics.Accuracy), backgroundColor: '#4e73df' },
                        { label: 'F1-Score', data: Object.values(data.model_metrics['F1-Score']), backgroundColor: '#1cc88a' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { title: { display: true, text: 'Model Performance Comparison' } },
                    scales: { y: { beginAtZero: true, max: 1.0 } }
                }
            });
        }
        
        // --- EVENT LISTENERS ---

        document.getElementById('analyzeCityBtn').addEventListener('click', async () => {
            const city = document.getElementById('citySelect').value;
            const year = document.getElementById('yearInput').value;
            const summaryElement = document.getElementById('citySummary');

            if (!city || !year) {
                summaryElement.innerHTML = `<span class="text-danger">Please select a City and a Year.</span>`;
                return;
            }

            summaryElement.innerHTML = `Analyzing <strong>${city}</strong> for <strong>${year}</strong>...`;

            try {
                const response = await fetch('/api/city_analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ city, year: parseInt(year) })
                });

                if (!response.ok) throw new Error('City analysis failed.');
                const data = await response.json();
                
                summaryElement.innerHTML = data.summary;

                renderCityAnalysisCharts(data.yearly_city_trend, data.top5_crimes);

            } catch (error) {
                console.error("Error during city analysis:", error);
                summaryElement.innerHTML = `<span class="text-danger">Analysis Error: ${error.message}</span>`;
            }
        });

        function renderCityAnalysisCharts(yearlyData, top5Data) {
            
            // Destroy and recreate canvas elements 
            ['yearlyCityChart', 'top5CityCrimesChart'].forEach(id => {
                const canvas = document.getElementById(id);
                if (window.ChartInstances[id]) window.ChartInstances[id].destroy();
                canvas.parentNode.innerHTML = `<canvas id="${id}"></canvas>`; 
            });

            const yearlyCtx = document.getElementById('yearlyCityChart').getContext('2d');
            window.ChartInstances.yearlyCityChart = new Chart(yearlyCtx, {
                type: 'line',
                data: {
                    labels: Object.keys(yearlyData),
                    datasets: [{
                        label: 'Yearly Crime Count',
                        data: Object.values(yearlyData),
                        borderColor: '#20c997',
                        tension: 0.1
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    plugins: { title: { display: true, text: 'Year-wise Crime Trend (City)' } }
                }
            });

            const top5Ctx = document.getElementById('top5CityCrimesChart').getContext('2d');
            window.ChartInstances.top5CityCrimesChart = new Chart(top5Ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(top5Data),
                    datasets: [{
                        label: 'Number of Cases',
                        data: Object.values(top5Data),
                        backgroundColor: '#fd7e14'
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    plugins: { title: { display: true, text: 'Top 5 Crimes in City' } }
                }
            });
        }
        
        // --- PREDICTION LOGIC ---
        document.getElementById('predictBtn').addEventListener('click', async () => {
            const resultElement = document.getElementById('predictionResult');
            resultElement.style.display = 'block';
            resultElement.className = 'alert alert-info';
            resultElement.innerHTML = 'Calculating prediction...';

            const predictionData = {
                City: document.getElementById('predCity').value,
                Primary_Type: document.getElementById('predType').value,
                Victim_Gender: document.getElementById('predGender').value,
                Victim_Age: document.getElementById('predAge').value,
                Weapon_Used: document.getElementById('predWeapon').value,
                Police_Deployed: document.getElementById('predPolice').value, 
                Date_Occurred: document.getElementById('predDate').value,
                Time_Occurred: document.getElementById('predTime').value
            };

            // Basic validation
            let missingField = Object.entries(predictionData).find(([key, value]) => value === null || value === "");
            if (missingField) {
                resultElement.className = 'alert alert-danger';
                resultElement.innerHTML = `Error: Please select a value for **${missingField[0].replace(/_/g, ' ')}**.`;
                return;
            }

            try {
                const response = await fetch('/api/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(predictionData)
                });

                const data = await response.json();

                if (response.ok) {
                    const statusText = data.status === 'CLOSED' ? 'Case Likely to be CLOSED' : 'Case Likely to Remain OPEN';
                    resultElement.className = data.status === 'CLOSED' ? 'alert alert-success' : 'alert alert-warning';
                    resultElement.innerHTML = `
                        <strong>Prediction Result: ${statusText}</strong>
                        <br>
                        Confidence Score (Case Closed): <strong>${data.confidence}%</strong>
                    `;
                } else {
                    resultElement.className = 'alert alert-danger';
                    resultElement.innerHTML = `Prediction Failed: ${data.error}`;
                }

            } catch (error) {
                console.error("Error during prediction:", error);
                resultElement.className = 'alert alert-danger';
                resultElement.innerHTML = `A network error occurred. Is the Flask server running?`;
            }
        });

        // Initial Data Load on page load
        window.onload = fetchAnalysisData;

    </script>
</body>
</html>
